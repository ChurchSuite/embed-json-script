document.addEventListener("alpine:init",()=>{Alpine.data("CSEvents",()=>({allEvents:[],categories:[],category:"",events:[],featuredEvents:[],search:"",site:"",sites:[],async init(){this.$watch(["category","search","site"],()=>this.filterEvents());let e=(await CS.fetchJSON("events")).filter(e=>"1"==e.signup_options.public.featured),s=[];e.forEach(e=>{null==e.category||this.categories.includes(e.category.name)||this.categories.push(e.category.name),null==e.site||this.sites.includes(e.site.name)||this.sites.push(e.site.name);var t=CS.timeFormat(e.datetime_start)+" - "+CS.timeFormat(e.datetime_end),t={_original:e,allDay:"12:00am - 11:59:59pm"==t,brandEmblem:e.brand.emblem,category:null!=e.category?e.category.name:null,description:CS.stringToHTML(e.description),date:new Date(e.datetime_start.replace(/-/g,"/")).toLocaleDateString("en-GB",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),shortDate:new Date(e.datetime_start.replace(/-/g,"/")).toLocaleDateString("en-GB",{weekday:"short",year:"2-digit",month:"short",day:"numeric"}),image:e.images.constructor===Object?e.images.md.url:e.brand.emblem,link:1==e.signup_options.signup_enabled?e.signup_options.tickets.url:"",location:e.location.name,name:e.name,postcode:e.location.address,site:null!=e.site?e.site.name:null,time:t};s.includes(e.name)||(this.events.push(t),s.push(e.name)),this.allEvents.push(t)}),this.featuredEvents=this.events},filterEvents(){this.search.length||this.category.length||this.site.length?this.events=this.allEvents.filter(e=>{var t=!this.search.length||(e.name+e.date+e.location+e.category).toLowerCase().includes(this.search.toLowerCase()),s=!this.category.length||e.category===this.category,e=null==e.site||(!this.site.length||e.site==this.site);return s&&t&&e}):this.events=this.featuredEvents}})),Alpine.data("CSGroups",()=>({allFormattedGroups:[],cluster:"",clusters:[],day:"",days:[],groups:[],options:{show_tags:1},search:"",site:"",sites:[],tag:"",tags:[],async init(){this.$watch(["day","tag","search","site","cluster"],()=>this.filterGroups());let e=await CS.fetchJSON("groups",this.options);this.days=CS.days(),e.forEach(e=>{null==e.site||this.sites.includes(e.site.name)||this.sites.push(e.site.name),null==e.cluster||this.clusters.includes(e.cluster.name)||this.clusters.push(e.cluster.name),null!=e.tags&&e.tags.forEach(e=>{this.tags.includes(e.name)||this.tags.push(e.name)}),this.sites.sort(),this.clusters.sort(),this.tags.sort(),this.allFormattedGroups.push({cluster:null!=e.cluster?e.cluster.name:null,customFields:e.custom_fields.constructor===Object?this.buildCustomFields(e):null,dateStart:new Date(e.date_start.replace(/-/g,"/")).toLocaleDateString("en-GB",{month:"short",year:"numeric"}),day:CS.days()[e.day],description:e.description.replace(/\r\n/g,"<br>"),frequency:e.frequency,image:e.images.constructor===Object?e.images.md.url:"",link:"https://"+CS.url+"/groups/"+e.identifier,location:e.location.name,name:e.name,online:"online"==e.location.type,site:null!=e.site?e.site.name:null,tags:e.tags,time:CS.timeFormat("1970-01-01 "+e.time),_original:e})}),this.groups=this.allFormattedGroups},buildCustomFields(s){let i=[];return Object.entries(s.custom_fields).forEach(e=>{const t=e[1];t.constructor===Object&&t.hasOwnProperty("formatted_value")&&t.settings.embed.view&&i.push({id:t.id,name:t.name,value:t.formatted_value,_original:[s.custom_fields["custom"+t.id],s.custom_fields["field"+t.id],s.custom_fields["field_"+t.id]]})}),i},filterGroups(){this.groups=this.allFormattedGroups.filter(e=>{var t=(null!=e.cluster||!this.cluster.length)&&(!this.cluster.length||e.cluster==this.cluster),s=!this.day.length||e.day==this.day,i=!this.tag.length||e.tags.map(e=>e.name).includes(this.tag),a=!this.search.length||e.name.toLowerCase().includes(this.search.toLowerCase()),e=null==e.site||(!this.site.length||e.site==this.site);return s&&i&&a&&e&&t})}}))}),window.CS={buildOptions:function(e){return 0!==Object.keys(e).length?"?"+new URLSearchParams(e).toString():""},days:function(){return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},fetchJSON:async function(t,e={}){let s;var i=localStorage.getItem(t);return null!=i&&JSON.parse(i).expires>(new Date).getTime()?s=JSON.parse(i).json:await fetch("https://"+CS.url+"/embed/"+("events"==t?"calendar":"smallgroups")+"/json"+this.buildOptions(e)).then(e=>e.json()).then(e=>{localStorage.setItem(t,JSON.stringify({expires:(new Date).getTime()+9e5,json:e})),s=e}),s},stringToHTML:function(e){return div=document.createElement("div"),div.innerHTML=e,div.textContent||div.innerText||""},timeFormat:function(e){return new Date(e.replace(/-/g,"/")).toLocaleTimeString("en-GB",{hourCycle:"h12"}).replace(/ /g,"").replace(":00","")}};